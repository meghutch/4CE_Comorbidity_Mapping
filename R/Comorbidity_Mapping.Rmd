---
title: "Comorbidity Mapping"
author: "Meg Hutch"
date: "11/9/2020"
output: html_document
---

This script adapts the [icd package](https://github.com/jackwasey/icd) by Jack Wasey to facilitate comorbidity mapping of diagnoses detailed in the 4CE Phase2.1 PatientObservations.csv file. This script will specifically map ICD 9 and 10 codes of COVID-19 patients to codes that comprise the Charlson Comorbidity Index and the Quan-Elixhauser Index. 

Of note: The aforementioned Comorbidity scoring indexes have been validated with specific ICD 9 and 10 codes. To protect patient confidentiality, the 4CE PatientObservations file has truncated ICD codes to their first 3 characters. Thus, the scoring and mapping may be inflated. If a site does have a file with the full/non-truncated ICD Codes, a separate script, Mapping_Evaluation.Rmd, can be used to explore the prevalence of extra comorbidities mapped.

However, if the specific mapping and scoring system are not desired, the icd package is still a nice package to quickly identify major comorbidities of interest.

**To be implemented:**

* Stratify Table1 with by severity

* Add Elixhauser Mapping & HCC which provides different/additional comorbidity categories

* A separate Rmd file to Evaluate difference between scores mapped with full ICD codes vs truncated ICD Codes


## Required Packages

```{r message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(icd)
library(kableExtra)
library(purrr)
library(tableone)
```

## Import Data

Replace path of simulated_data with that of your site's Phase2.1 PatientObservations csv file.
```{r}
#my_path = "C:/Users/User/Box Sync/Projects/4CE_Comorbidity_Mapping/simulated_data/data.csv"
my_path = "C:/Users/User/Box Sync/Projects/4CE_Comorbidity_Mapping/nwu_data/PatientObservations.csv"

data <- read.csv(my_path)
```

# Charlson Mapping

The following will map ICD codes to the codes that comprise the Charlson Comorbidity Index. The Comorbidity Score is calculated based on both Charlson and Quan scoring systems (differing weights given to comorbidities).
If a site has ICD9 or ICD 10 Codes, the mapping must be performed separately and then results can be combined

```{r}
map_charlson_codes <- function(data) { 

  data <- data %>% filter(concept_type == "DIAG-ICD10" | concept_type == "DIAG-ICD9")
  
  # filter for diagnoses prior to admission
  data <- data %>% filter(days_since_admission < 0)
  
  # Create separate data frames for ICD9 and 10 Codes
  # icd package does not support simultaneous processing of both ICD code types
  # we will recombine after the initial processing
  icd10 <- data %>% 
    filter(concept_type == "DIAG-ICD10") %>% 
    distinct()

  icd9 <- data %>%
    filter(concept_type == "DIAG-ICD9") %>% 
    distinct()
  
    ## Because the 4CE has truncated ICD codes, we will also truncate the icd package index maps
    # Function to select first 3 characters of the ICD Code in all lists of the index map
    first_3 <- function(x) { 
      x <- substr(x, 1, 3)
      return(x)
    }
    
  icd10_map_charlson3 <- lapply(icd10_map_charlson, sapply, first_3)
  icd9_map_charlson3 <- lapply(icd9_map_charlson, sapply, first_3)
  
  # perform the mapping
  icd10_map <- icd10_comorbid(icd10, map = icd10_map_charlson3, icd_name = "concept_code",
                              return_df = TRUE, visit_name = "patient_num", 
                              return_binary = TRUE)

  icd9_map <- icd9_comorbid(icd9, map = icd9_map_charlson3, icd_name = "concept_code", 
                            return_df = TRUE, visit_name = "patient_num", 
                            return_binary = TRUE)
  

  # Combine the results of the 9 and 10 mapping
  icd_map <- rbind(icd9_map, icd10_map)

  # If multiple rows due to a patient having both ICD 9 and 10 codes, we will take the max of the column 
  # This will allow us to capture the 1s indicating that the comorbidity is present
  # the try wrapper is important in cases there is not an instance of a specific comorbidity in the data - try silences errors
  icd_map <- icd_map %>% 
    group_by(patient_num) %>% 
    mutate(MI = try(max(MI), silent = TRUE)) %>%
    mutate(CHF = try(max(CHF), silent = TRUE)) %>%
    mutate(PVD = try(max(PVD), silent = TRUE)) %>%
    mutate(Stroke = try(max(Stroke), silent = TRUE)) %>% 
    mutate(Dementia = try(max(Dementia), silent = TRUE)) %>%
    mutate(Pulmonary = try(max(Pulmonary), silent = TRUE)) %>%
    mutate(Rheumatic = try(max(Rheumatic), silent = TRUE)) %>%
    mutate(PUD = try(max(PUD), silent = TRUE)) %>%
    mutate(LiverMild = try(max(LiverMild), silent = TRUE)) %>%
    mutate(DM = try(max(DM), silent = TRUE)) %>%
    mutate(DMcx = try(max(DMcx), silent = TRUE)) %>%
    mutate(Paralysis = try(max(Paralysis), silent = TRUE)) %>%
    mutate(Renal = try(max(Renal), silent = TRUE)) %>%
    mutate(Cancer = try(max(Cancer), silent = TRUE)) %>%
    mutate(LiverSevere = try(max(LiverSevere), silent = TRUE)) %>%
    mutate(Mets = try(max(Mets), silent = TRUE)) %>%
    mutate(HIV = try(max(HIV), silent = TRUE)) %>%
    slice(1L)
  
  icd_map <- icd_map %>% arrange(as.numeric(patient_num))
  
  table1 <- as.data.frame(colSums(Filter(is.numeric,icd_map)))
  table1 <- tibble::rownames_to_column(table1, "Comorbidity")
  
  # replace abbreviations with full comorbidity name
  names_charlson_df = map_df(names_charlson, ~as.data.frame(.x), 
                             .id="code")
  colnames(names_charlson_df)[2] <- "Name"
  
  names_charlson_abbrev_df <- map_df(names_charlson_abbrev, ~as.data.frame(.x),
                                     .id="code")
  colnames(names_charlson_abbrev_df)[2] <- "Comorbidity"
  
  comorb_list_names <- full_join(names_charlson_df, names_charlson_abbrev_df,
                                 by = "code")
  
  table1 <- merge(table1, comorb_list_names, by = "Comorbidity")
  table1$code <- NULL
  colnames(table1)[2] <- "Patients"
  table1 <- table1 %>%
    select(-Comorbidity) %>%
    arrange(desc(Patients)) %>%
    mutate(percent = round(Patients/nrow(icd_map)*100,2)) %>%
    select(Name, Patients, percent)
  colnames(table1)[1] <- "Comorbidity"
  
  ## Calculate Index Scores
  charlson_score = charlson_from_comorbid(icd_map, 
                                        visit_name = "patient_num", 
                                        scoring_system = "charlson",  
                                        hierarchy = TRUE)

  quan_score = charlson_from_comorbid(icd_map, 
                                      visit_name = "patient_num", 
                                      scoring_system = "quan", 
                                      hierarchy = TRUE)
  
  charlson_score <- as.data.frame(charlson_score)
  charlson_score <- tibble::rownames_to_column(charlson_score, "patient_num")
    
  quan_score <- as.data.frame(quan_score)
  quan_score <- tibble::rownames_to_column(quan_score, "patient_num")
  
  index_scores <- full_join(icd_map, charlson_score, by = "patient_num")
  index_scores <- full_join(index_scores, quan_score, by = "patient_num")
  
  # calculate difference between Charlson and Quan scores
  index_scores <- index_scores %>%
    arrange(as.numeric(patient_num)) %>%
    mutate(score_diff = charlson_score - quan_score) %>% 
    mutate(abs_score_diff = abs(score_diff)) %>%
    arrange(desc(charlson_score)) %>%
    select(patient_num, charlson_score, quan_score,
           score_diff, abs_score_diff, everything())
    
  
  
  ## Identify the specific codes that mapped
  
  # First we will add the comorbidity abbreviation adjacent to the mapped ICD Code
  comorb_names = c("MI", "CHF", "PVD", "Stroke", "Dementia", "Pulmonary", "Rheumatic",
                   "PUD", "LiverMild", "DM", "DMcx", "Paralysis", "Renal", "Cancer",
                   "LiverSevere", "Mets", "HIV")
  
  # unlist the charlson mapping lists
  icd10_code_map <- map_df(icd10_map_charlson3, ~as.data.frame(.x), .id="name")
  colnames(icd10_code_map) <- c("Comorbidity", "concept_code")
  
  icd10_code_map$concept_code <- as.character(icd10_code_map$concept_code)
  
  icd10_code_map <- icd10_code_map %>% 
    filter(!concept_code %in% comorb_names) %>%
    distinct()
  
  icd9_code_map <- map_df(icd9_map_charlson3, ~as.data.frame(.x), .id="name")
  colnames(icd9_code_map) <- c("Comorbidity", "concept_code")
  
  icd9_code_map <- icd9_code_map %>% 
    filter(!concept_code %in% comorb_names) %>%
    distinct()
  
  # merge the mapping dataframe to the patient level ICD codes
  # this will return all comorbidities that mapped to our patient data
  icd10_map <- inner_join(icd10, icd10_code_map, by = "concept_code")
  icd9_map <- inner_join(icd9, icd9_code_map, by = "concept_code")
    
  # explain_codes will add additional information regarding the code name 
  # add if statements in order to handle sites that only have ICD 9 or 10 codes but not both
  
  if (nrow(icd10_map) > 0) {
    
  icd10_mapped_table <- explain_table(icd10_map$concept_code)
  colnames(icd10_mapped_table)[1] <- "concept_code"
  icd10_mapped_table <- icd10_mapped_table %>% distinct()
  
  icd10_mapped_table <- left_join(icd10_map, icd10_mapped_table, by = "concept_code")
  
  # keep columns of interest 
  icd10_mapped_table <- icd10_mapped_table %>%
    select(patient_num, concept_code, Comorbidity, long_desc) %>% 
    distinct()
  }
   
  if (nrow(icd9_map) > 0) {
  
  icd9_mapped_table <- explain_table(icd9_map$concept_code)
  colnames(icd9_mapped_table)[1] <- "concept_code"
  icd9_mapped_table <- icd9_mapped_table %>% distinct()
  
  icd9_mapped_table <- left_join(icd9_map, icd9_mapped_table, by = "concept_code")
  
  # keep columns of interest 
  icd9_mapped_table <- icd9_mapped_table %>%
    select(patient_num, concept_code, Comorbidity, long_desc) %>% 
    distinct()
  } 

  
  # Bind both ICD 9 and 10 code tables togethe
  mapped_codes_table <- rbind(try(icd10_mapped_table, icd9_mapped_table), silent = TRUE)

  
  # calculate how many patients had each unique Comorbidity/concept_code
  mapped_codes_table <- mapped_codes_table %>%
    group_by(concept_code, Comorbidity, long_desc) %>%
    mutate(n_patients = n()) %>%
    ungroup() %>%
    group_by(long_desc, n_patients) %>%
    arrange(desc(n_patients)) %>%
    select(-patient_num) %>%
    distinct()
  
  map_results <- list(comorb_list_names, icd_map, index_scores, table1, mapped_codes_table)

  return(map_results)

  }
```

```{r}
comorb <- map_charlson_codes(data)

comorb_list_names <- comorb[[1]]
icd_map <- comorb[[2]]
index_scores <- comorb[[3]]
table1 <- comorb[[4]]
mapped_codes_table <- comorb[[5]]
```

## Comorbidity Abbreviation Table
```{r}
comorb_list_names <- comorb_list_names %>%
  select(Comorbidity, Name)
colnames(comorb_list_names) <- c("Abbreviation", "Comorbidity")

print(comorb_list_names)
```


## Display Comorbidity Matrix

The following code will print the comorbidity matrix with a subset of patients (n)
```{r}
head(icd_map, n = 10) %>%
  kable("html", escape = F) %>%
  kable_styling(bootstrap_options = "striped")
```

## Comorbidity Score

The following code will print the n patients with the highest Charlson comorbidity score.

The Quan scoring system is also displayed along with the different between the two scoring systems.

```{r}
head(index_scores, n = 20) %>%
  kable("html", escape = F) %>%
  kable_styling(bootstrap_options = "striped")
```

## Table1

The below table displays the number of patients with each comorbidity
```{r}
table1 %>%
  kable("html", escape = F) %>%
  kable_styling(bootstrap_options = "striped")
```

## Mapped Codes 

The below table prints the top n number of mapped ICD Code/Comorbidity pairings

*Note:* Some codes pair to more than one comorobidity. For example, CHF (Congestive Heart Failure) and MI (Myocardial Infarction), may have codes in common.

```{r}
head(mapped_codes_table, n = 10) %>%
  kable("html", escape = F) %>%
  kable_styling(bootstrap_options = "striped")
```

## Add Elixhauser Mapping!
